<!-- ÏóêÎîîÌÑ∞ -->
<!-- Toast UI EditorÏùò Ïä§ÌÉÄÏùºÏãúÌä∏ -->
<link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
<link rel="stylesheet" href="/assets/toast_dark_theme.css">
<!-- Toast UI EditorÏùò JavaScript -->
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

<!-- Î©îÏù∏ ÌãÄ -->
<div id="base" class="flex duration-200 bg-[#3f3f3f] text-gray-50 w-full relative">

  <!-- Î©îÏù∏ -->
  <div class="md:mb-20 w-full p-1 md:p-5 flex flex-col gap-5">

    <div class="bg-[#2f2f2f] p-5 flex flex-col gap-5 border border-gray-500 rounded">
      
      <div class="">
        <div class="flex gap-3">
          <p>"<?= htmlspecialchars($post->title) ?>"</p>
          <p>ÏàòÏ†ïÌïòÍ∏∞ ü™Ñ</p>
        </div>
        <input id="bd_id" name="bd_id" type="number" hidden value="<?= $post->idx ?>">
      </div>

      <!-- Íµ¨Î∂ÑÏÑ† -->
      <div class="border-b border-gray-500"></div>
      
      <div class="flex flex-col gap-5">

        <!-- <form class="flex flex-col gap-5" action="/free_board_create/create" method="post"> -->
        <form class="flex flex-col gap-5" action="/free_board_create_c/create" method="post">
          
          <!-- Í≤åÏãúÌåê ÏÑ†ÌÉù Î∞è Ï†úÎ™© -->
          <div class="bg-[#2f2f2f] flex flex-col md:flex-row gap-5">
  
            <!-- ÏÖÄÎ†âÌÑ∞ -->
            <div class="w-full md:w-[30%]">
              <!-- <label for="lang">Language</label> -->
              <input id="board_type" hidden value="<?= $post->board_type ?>" type="text">
              <select id='post_type' name='post_type' required class="outline-none w-full text-whith rounded bg-[#4f4f4f] p-3">
                <option class="hidden">
                  <?= $post->board_type == 'notice' ? 'Í≥µÏßÄÏÇ¨Ìï≠' : '' ?>
                  <?= $post->board_type == 'freeboard' ? 'ÏûêÏú†Í≤åÏãúÌåê' : '' ?>
                  <?= $post->board_type == 'hellow' ? 'Í∞ÄÏûÖÏù∏ÏÇ¨' : '' ?>
                </option>
                <option value="notice" class="<?= $this->session->userdata('user_id') == 'admin' ? '' : 'hidden' ?>">
                  Í≥µÏßÄÏÇ¨Ìï≠
                </option>
                <option value="freeboard">ÏûêÏú†Í≤åÏãúÌåê</option>
                <option value="hellow">Í∞ÄÏûÖÏù∏ÏÇ¨</option>
              </select>
            </div>
  
            <!-- Ï†úÎ™©ÏûÖÎ†• -->
            <div class="w-full md:w-[70%]">
              <input id='post_title' name='post_title' value="<?= htmlspecialchars($post->title) ?>" class="w-full outline-none text-whith rounded bg-[#4f4f4f] p-3" required name="title" type="text" placeholder="Ï†úÎ™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî"/>
            </div>
  
          </div>

          <!-- Í≤åÏãúÍ∏Ä ÎÇ¥Ïö© ÏûëÏÑ± -->
          <div id="editor"></div>

          <!-- Í≥µÍ∞ú/ÎπÑÍ≥µÍ∞ú -->
          <div class="flex flex-col md:flex-row gap-3">
            <div class="flex flex-col gap-2 w-full">
              <h2>Í≤åÏãúÍ∏Ä Í≥µÍ∞ú</h2>
              
              <div class="flex gap-3">
                <div class="w-full flex">
                  <input id="1_a" type="radio" value="1" <?= $post->board_state ? 'checked' : ''?> name="post_open" class="hidden peer">
                  <label for="1_a" class="duration-200 w-full py-4 font-medium border rounded peer-checked:border-yellow-500 ps-5 peer-checked:shadow-2xl peer-checked:text-yellow-500 text-[#9f9f9f] border-[#1f1f1f] bg-[#1f1f1f]">
                    <div class="flex gap-1 place-items-center">
                      <span class="material-symbols-outlined">
                        check_small
                      </span>
                      <p class="">
                        Í≥µÍ∞ú
                      </p>
                    </div>
                  </label>
                </div>
                <div class="w-full flex">
                  <input id="2_a" type="radio" value="0" <?= !$post->board_state ? 'checked' : ''?> name="post_open" class="hidden peer">
                  <label for="2_a" class="duration-200 w-full py-4 font-medium border rounded peer-checked:border-yellow-500 ps-5 peer-checked:shadow-2xl peer-checked:text-yellow-500 text-[#9f9f9f] border-[#1f1f1f] bg-[#1f1f1f]">
                    <div class="flex gap-1 place-items-center">
                      <span class="material-symbols-outlined">
                        check_small
                      </span>
                      <p class="">
                        ÎπÑÍ≥µÍ∞ú
                      </p>
                    </div>
                  </label>
                </div>
              </div>

            </div>
            <div class="flex flex-col gap-2 w-full">
              <h2>ÎåìÍ∏Ä ÏûëÏÑ±</h2>
              
              <div class="flex gap-3">

                <div class="flex w-full">
                  <input id="1_b" type="radio" value="1" <?= $post->board_comment ? 'checked' : ''?> name="comment_open" class="hidden peer">
                  <label for="1_b" class="duration-200 w-full py-4 font-medium border rounded peer-checked:border-yellow-500 ps-5 peer-checked:shadow-2xl peer-checked:text-yellow-500 text-[#9f9f9f] border-[#1f1f1f] bg-[#1f1f1f]">
                    <div class="flex gap-1 place-items-center">
                      <span class="material-symbols-outlined">
                        check_small
                      </span>
                      <p class="">
                        Í≥µÍ∞ú
                      </p>
                    </div>
                  </label>
                </div>

                <div class="flex w-full">
                  <input id="2_b" type="radio" value="0" <?= !$post->board_comment ? 'checked' : ''?> name="comment_open" class="hidden peer">
                  <label for="2_b" class="duration-200 w-full py-4 font-medium border rounded peer-checked:border-yellow-500 ps-5 peer-checked:shadow-2xl peer-checked:text-yellow-500 text-[#9f9f9f] border-[#1f1f1f] bg-[#1f1f1f]">
                    <div class="flex gap-1 place-items-center">
                      <span class="material-symbols-outlined">
                        check_small
                      </span>
                      <p class="">
                        ÎπÑÍ≥µÍ∞ú
                      </p>
                    </div>
                  </label>
                </div>

              </div>

            </div>
          </div>

          <!-- Ï≤®Î∂ÄÌååÏùº ÎØ∏Î¶¨Î≥¥Í∏∞ -->
          <div id="file_preview" class="flex flex-col gap-2">
            <p>Ï≤®Î∂Ä ÌååÏùº</p>
            <div id="preview" class="shadow-xl w-full grid grid-cols-3 md:grid-cols-5 md:flex md:flex-wrap place-items-center border border-[#4f4f4f] justify-center gap-3 duration-200 min-h-[208px] bg-[#3f3f3f] rounded p-3">
            </div>
          </div>

          <!-- Ï≤®Î∂ÄÌååÏùº -->
          <div id="file_control" class="flex place-items-center justify-center w-full">
            <label for="userfile" class="flex flex-col items-center w-full justify-center h-52 border-2 border-gray-500 border-dashed rounded-lg cursor-pointer hover:bg-[#2f2f2f] duration-200 bg-[#3f3f3f]">
              <div class="flex flex-col gap-3 place-items-center justify-center text-sm">
                <div class="flex place-items-center gap-3 duration-200 animate-pulse">
                  <span class="material-symbols-outlined flex gap-2 place-items-center">
                    add_link
                  </span>
                  <p class="">
                    ÌååÏùºÏùÑ Ï≤®Î∂ÄÌïòÎ†§Î©¥ ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî (ÏµúÎåÄ 5Í∞ú)
                  </p>
                </div>
                <div class="flex gap-2">
                  <? $file_type = array('JPG', 'JPEG', 'PNG', 'GIF', 'TXT', 'ZIP') ?>
                  <? foreach($file_type as $list):?>
                    <p class="bg-[#4f4f4f] px-2 py-0.5 rounded border border-[#5f5f5f]">
                      <?= $list ?>
                    </p>
                  <? endforeach ?>
                </div>
              </div>
              <input name="userfile[]" id="userfile" multiple type="file" class="hidden" />
            </label>
          </div>

          <!-- Íµ¨Î∂ÑÏÑ† -->
          <div class="border-b border-gray-500"></div>

          <!-- Ï†ïÎ≥¥Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏùÑÏãú -->
          <div id='error_form' class="relative duration-200 animate-bounce shadow-xl hidden flex p-5 gap-3 border border-[#4f4f4f] bg-[#1f1f1f] w-full rounded">
            <span class="material-symbols-outlined duration-200 animate-pulse text-red-400">
              error
            </span>
            <p id='error_txt'>
              <?= validation_errors(); ?>
            </p>
            <button class="remove-btn hover:scale-125 rounded-[50%] absolute top-2 duration-200 w-5 h-5 flex justify-center place-items-center right-2 p-1 bg-[#1f1f1f] hover:bg-red-500">
              <span class="material-symbols-outlined text-[20px]">
                close
              </span>
            </button>
          </div>

          <!-- Í≤åÏãúÍ∏Ä ÏàòÏ†ï -->
          <div class="w-full text-right">
            <button id='create_btn' name='create_btn' class="p-3 w-full md:w-[400px] rounded bg-blue-500 duration-200 hover:opacity-80">
              Í≤åÏãúÍ∏Ä ÏàòÏ†ï
            </button>
            <!-- <input type="submit" class="p-3 w-[400px] rounded bg-blue-500 duration-200 hover:opacity-80" value="Í≤åÏãúÍ∏Ä Îì±Î°ù"></input> -->
          </div>

        </form>

      </div>

    </div>
    
  </div>
  <!-- Î©îÏù∏ÎÅù -->

</div>
<!-- <script src="/javascript/board/board_create.js"></script> -->

<script>
  // Ï≤®Î∂ÄÌååÏùº ÎØ∏Î¶¨Î≥¥Í∏∞
  let selectedFiles = [];
  let editorInstance;
  let existingFiles = <?= json_encode($file); ?>;

// ajax Í≤åÏãúÍ∏Ä Îì±Î°ù
$(document).ready( () => {

  // Í≤åÏãúÌåê ÌÉÄÏûÖ Î≥ÄÍ≤Ω Ï≤¥ÌÅ¨
  // document.getElementById('post_type').addEventListener('change', function(e) {
  //   console.log(e.target.value);
  //   $('#post_type').val() == e.target.value;
  // });

  // Ï≤®Î∂ÄÌååÏùº ÎØ∏Î¶¨Î≥¥Í∏∞ divÏùò Í∞ÄÏãúÏÑ± ÏÑ§Ï†ï
  updateFilePreviewVisibility();

  // ÌÜ†Ïä§Ìä∏ UI ÏóêÎîîÌÑ∞ Ïù∏Ïä§ÌÑ¥Ïä§ ÏÉùÏÑ±
  editor = new toastui.Editor({
    el: document.querySelector('#editor'),
    height: '700px',
    initialEditType: 'wysiwyg',
    previewStyle: 'vertical',
    usageStatistics: false,
    theme: 'dark',
    initialValue: '<?= $post->content ?>',
    hooks: {
      addImageBlobHook: (blob, callback) => {
        const formData = new FormData();
        formData.append('image', blob);
        $.ajax({
          url: '/free_board_create_c/upload_image', // Ïù¥ÎØ∏ÏßÄÎ•º ÏóÖÎ°úÎìúÌï† ÏÑúÎ≤ÑÏùò URL
          data: formData,
          type: 'POST',
          processData: false,
          contentType: false,
          success: (response) => {
            console.log('ÏóêÎîîÌÑ∞', response);
            const result = JSON.parse(response);
            if(result.state) {
              callback(result.url, result.blob ?? 'Ïù¥ÎØ∏ÏßÄ ÏÑ§Î™Ö ÏóÜÏùå'); // ÏÑ±Í≥µ Ïãú ÏóêÎîîÌÑ∞Ïóê Ïù¥ÎØ∏ÏßÄ URL ÏÇΩÏûÖ
            } else {
              alert('Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú Ïã§Ìå®: ' + result.message);
            }
          },
          error: () => {
            alert('Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú Ï§ë ÏÑúÎ≤Ñ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
          }
        });
      }
    }
  });

  function updateFileIndexes() {
    document.querySelectorAll('.preview-item').forEach((item, index) => {
      item.setAttribute('data-index', index); // ÎØ∏Î¶¨Î≥¥Í∏∞ ÏïÑÏù¥ÌÖú Ïù∏Îç±Ïä§ ÏóÖÎç∞Ïù¥Ìä∏
    });
  }

  $('#create_btn').click( e => {
    
    e.preventDefault();

    $('#error_txt').empty(); // ÏóêÎü¨ Î©îÏãúÏßÄ Ï¥àÍ∏∞Ìôî
    $('#error_form').removeClass('hidden');
    
    if($('#post_type').val() == null) { // Í≤åÏãúÍ∏Ä ÌÉÄÏûÖ
      $('#error_txt').text('Í≤åÏãúÌåêÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
      return;
    }

    if($('#post_title').val().length < 2 || $('#post_title').val().length > 50 ) { // Í≤åÏãúÍ∏Ä Ï†úÎ™©
      $('#error_txt').text('Í≤åÏãúÌåê Ï†úÎ™©ÏùÄ 2~50Ïûê Ïù¥ÎÇ¥Î°ú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
      return;
    }

    if(editor.getHTML().length < 20) { // Í≤åÏãúÍ∏Ä ÎÇ¥Ïö©
      $('#error_txt').text('Í≤åÏãúÌåê ÎÇ¥Ïö©ÏùÄ 10Ïûê Ïù¥ÏÉÅ ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.');
      return;
    }

    if(editor.getHTML().length > 10000 ) { // Í≤åÏãúÍ∏Ä ÎÇ¥Ïö©
      $('#error_txt').text('Í≤åÏãúÌåê ÎÇ¥Ïö©ÏùÄ 10000Ïûê Ïù¥ÏÉÅ ÏûÖÎ†•Ìï† Ïàò ÏóÜÏäµÎãàÎã§.');
      return;
    }

    const formData = new FormData();
    formData.append('idx', $('#bd_id').val());
    formData.append('post_type', $('#post_type').val());
    formData.append('post_title', $('#post_title').val());
    formData.append('post_value', editor.getHTML());
    // formData.append('post_value', editor.getMarkdown());
    formData.append('post_open', $('input[name="post_open"]:checked').val());
    formData.append('comment_open', $('input[name="comment_open"]:checked').val());

    formData.append('old_file', existingFiles.length);

    // Ïñ¥ÎìúÎØºÎßå Í≥µÏßÄÏÇ¨Ìï≠ ÏÇ¨Ïö©
    if($('#post_type').val() == 'notice') {
      if('<?= $this->session->userdata('user_id') ?>' != 'admin') {
        $('#error_txt').text('Í¥ÄÎ¶¨ÏûêÎßå Í≥µÏßÄÏÇ¨Ìï≠ÏùÑ ÏÇ¨Ïö©Ìï† Ïàò ÏûàÏäµÎãàÎã§.');
        return;
      }
    }

    const fileInput = $('input[type="file"]')[0];
    // Ïù¥ÎØ∏ÏßÄ ÌååÏùºÏù¥ ÏûàÏúºÎ©¥ formDataÏóê Ï∂îÍ∞Ä

    // console.log('Ï∂îÍ∞Ä ', 'selectedFiles', selectedFiles.length);
    // console.log('Í∏∞Ï°¥ ', 'existingFiles', existingFiles.length);
    // console.log('ÌÅ¨Î¶¨ÏóêÏù¥Ìä∏ Î≤ÑÌäº', 'fileInput', fileInput.files.length);

    if(selectedFiles.length + existingFiles.length > 5) {
      alert('ÌååÏùºÏùÄ ÏµúÎåÄ 5Í∞úÍπåÏßÄ ÏóÖÎ°úÎìú Í∞ÄÎä•Ìï©ÎãàÎã§.');
      return;
    }

    if (fileInput.files.length > 0) {
      for (const file of selectedFiles) {
        formData.append('userfile[]', file);
      }
    }

    // AJAX ÏöîÏ≤≠ÏúºÎ°ú Í≤åÏãúÍ∏Ä ÏÉùÏÑ± Î∞è Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú Ï≤òÎ¶¨
    $.ajax({
      url: '/free_board_update_c/post_update',
      type: 'POST',
      data: formData,
      processData: false,
      contentType: false,
      dataType: 'json',
      success: (response) => {
        if (response.state) {
          $('#error_form').addClass('hidden');
          location.href = '/' + $('#board_type').val() +'/' + $('#bd_id').val();
        } else {
          $('#error_txt').append(response.message);
        }
      },
      error: () => {
        alert('Í≤åÏãúÍ∏Ä ÏàòÏ†ï Ï§ë ÏÑúÎ≤Ñ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
      }
    });
  });

  function createFilePreview(file, index, isExistingFile) {
    var previewContainer = document.getElementById('preview');
    var div = document.createElement('div');
    div.classList.add('preview-item');
    div.setAttribute('data-index', index);

    // ÌååÏùº ÎØ∏Î¶¨Î≥¥Í∏∞ HTML Íµ¨ÏÑ± (Í∏∞Ï°¥ ÌååÏùºÍ≥º ÏÉà ÌååÏùºÏóê Îî∞Îùº Îã§Î•º Ïàò ÏûàÏùå)
    if (isExistingFile) {
    // Í∏∞Ï°¥ ÌååÏùº ÎØ∏Î¶¨Î≥¥Í∏∞
    
    div.innerHTML = `
      <div class="gap-3">
        <div class="relative">
          <img src="/uploads/${file.file_name}" class="w-32 h-32 lg:w-40 lg:h-40 border border-gray-500 rounded duration-200 hover:scale-95 hover:rounded-none" />
          <button class="remove-btn existing-file-btn rounded-[50%] absolute top-2 duration-200 w-8 h-8 flex justify-center place-items-center right-2 p-2 bg-[#1f1f1f] hover:bg-red-500" data-file-id="${file.id}" data-file-name="${file.file_name}">
            <span class="material-symbols-outlined">
              close
            </span>
          </button>
        </div>
      </div>
    `;

    // if(e.target.result.match(/image/g)) {
    //       div.innerHTML = `
    //         <div class="flex gap-3">
    //           <div class="relative">
    //             <img src="${e.target.result}" class="w-20 h-20 md:w-32 md:h-32 lg:w-40 lg:h-40 border border-gray-500 rounded duration-200 hover:scale-95 hover:rounded-none" />
    //             <button class="remove-btn rounded-[50%] absolute top-2 duration-200 w-8 h-8 flex justify-center place-items-center right-2 p-2 bg-[#1f1f1f] hover:bg-red-500">
    //               <span class="material-symbols-outlined">
    //                 close
    //               </span>
    //             </button>
    //           </div>
    //         </div>
    //       `;
    //     } else {
    //       div.innerHTML = `
    //         <div class="flex gap-3">
    //           <div class="relative">
    //             <span class="material-symbols-outlined flex place-items-center justify-center text-6xl w-20 h-20 md:w-32 md:h-32 lg:w-40 lg:h-40 border border-gray-500 rounded duration-200 hover:scale-95 hover:rounded-none"">
    //               description
    //             </span>
    //             <button class="remove-btn rounded-[50%] absolute top-2 duration-200 w-8 h-8 flex justify-center place-items-center right-2 p-2 bg-[#1f1f1f] hover:bg-red-500">
    //               <span class="material-symbols-outlined">
    //                 close
    //               </span>
    //             </button>
    //           </div>
    //         </div>
    //       `;
    //     }

  } else {
    // ÏÉà ÌååÏùº ÎØ∏Î¶¨Î≥¥Í∏∞
    var reader = new FileReader();
    reader.onload = function(e) {

      div.innerHTML = `
        <div class="gap-3">
          <div class="relative">
            <img src="${e.target.result}" class="w-32 h-32 lg:w-40 lg:h-40 border border-gray-500 rounded duration-200 hover:scale-95 hover:rounded-none" />
            <button class="remove-btn rounded-[50%] absolute top-2 duration-200 w-8 h-8 flex justify-center place-items-center right-2 p-2 bg-[#1f1f1f] hover:bg-red-500">
              <span class="material-symbols-outlined">
                close
              </span>
            </button>
          </div>
        </div>
      `;

      // if(e.target.result.match(/image/g)) {
      //     div.innerHTML = `
      //       <div class="flex gap-3">
      //         <div class="relative">
      //           <img src="${e.target.result}" class="w-20 h-20 md:w-32 md:h-32 lg:w-40 lg:h-40 border border-gray-500 rounded duration-200 hover:scale-95 hover:rounded-none" />
      //           <button class="remove-btn rounded-[50%] absolute top-2 duration-200 w-8 h-8 flex justify-center place-items-center right-2 p-2 bg-[#1f1f1f] hover:bg-red-500">
      //             <span class="material-symbols-outlined">
      //               close
      //             </span>
      //           </button>
      //         </div>
      //       </div>
      //     `;
      //   } else {
      //     div.innerHTML = `
      //       <div class="flex gap-3">
      //         <div class="relative">
      //           <span class="material-symbols-outlined flex place-items-center justify-center text-6xl w-20 h-20 md:w-32 md:h-32 lg:w-40 lg:h-40 border border-gray-500 rounded duration-200 hover:scale-95 hover:rounded-none"">
      //             description
      //           </span>
      //           <button class="remove-btn rounded-[50%] absolute top-2 duration-200 w-8 h-8 flex justify-center place-items-center right-2 p-2 bg-[#1f1f1f] hover:bg-red-500">
      //             <span class="material-symbols-outlined">
      //               close
      //             </span>
      //           </button>
      //         </div>
      //       </div>
      //     `;
      //   }

    };
    reader.readAsDataURL(file);
  }

  // ÏÇ≠Ï†ú Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
  div.querySelector('.remove-btn').addEventListener('click', function() {
    if (isExistingFile) {
      // ÏÑúÎ≤ÑÏóê ÌååÏùº ÏÇ≠Ï†ú ÏöîÏ≤≠
      // ÏÑ±Í≥µ Ïãú selectedFilesÏóêÏÑú Ï†úÍ±∞ Î∞è ÎØ∏Î¶¨Î≥¥Í∏∞ ÏïÑÏù¥ÌÖú Ï†úÍ±∞
      div.remove();
    } else {
      // ÏÉà ÌååÏùºÏùò Í≤ΩÏö∞ Îã®ÏàúÌûà selectedFilesÏóêÏÑú Ï†úÍ±∞ Î∞è ÎØ∏Î¶¨Î≥¥Í∏∞ ÏïÑÏù¥ÌÖú Ï†úÍ±∞
      selectedFiles.splice(index, 1);
      div.remove();
      updateFileIndexes();
    }
    // Ï≤®Î∂ÄÌååÏùº ÎØ∏Î¶¨Î≥¥Í∏∞ divÏùò Í∞ÄÏãúÏÑ± ÏÑ§Ï†ï
    updateFilePreviewVisibility();
  });

  previewContainer.appendChild(div);
}
  
  // Í∏∞Ï°¥ ÌååÏùº ÎØ∏Î¶¨Î≥¥Í∏∞ ÏÉùÏÑ±
  existingFiles.forEach(function(fileItem, index) {
    createFilePreview(fileItem, index, true); // trueÎäî Í∏∞Ï°¥ ÌååÏùºÏûÑÏùÑ ÎÇòÌÉÄÎÉÖÎãàÎã§.
  });

  // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä: ÏÑúÎ≤ÑÏóêÏÑú ÌååÏùº ÏÇ≠Ï†ú
  $(document).on('click', '.existing-file-btn', function(e) {
    e.preventDefault();

    var fileId = $(this).data('file-id');
    var fileName = $(this).data('file-name');
    var div = this.parentElement.parentElement;
    var index = parseInt(div.getAttribute('data-index'));

    // AJAXÎ•º ÌÜµÌï¥ ÏÑúÎ≤ÑÏóê ÌååÏùº ÏÇ≠Ï†ú ÏöîÏ≤≠
    $.ajax({
      url: '/free_board_update_c/file_delete',
      type: 'POST',
      data: { id: fileId, name: fileName },
      dataType: 'json',
      success: function(response) {
        if (response.state) {
          console.log('ÌååÏùº ÏÇ≠Ï†ú ÏÑ±Í≥µ: ', response);
          existingFiles.splice(index, 1);
          // div.remove();
          // updateFileIndexes();
          // Ï≤®Î∂ÄÌååÏùº ÎØ∏Î¶¨Î≥¥Í∏∞ divÏùò Í∞ÄÏãúÏÑ± ÏÑ§Ï†ï
          updateFilePreviewVisibility();
        } else {
          alert('ÌååÏùº ÏÇ≠Ï†ú Ïã§Ìå®: ' + response.message);
        }
      },
      error: function() {
        alert('ÌååÏùº ÏÇ≠Ï†ú Ï§ë Ïò§Î•ò Î∞úÏÉù');
      }
    });
    // Ï≤®Î∂ÄÌååÏùº ÎØ∏Î¶¨Î≥¥Í∏∞ divÏùò Í∞ÄÏãúÏÑ± ÏÑ§Ï†ï
    updateFilePreviewVisibility();
  });

  document.getElementById('userfile').addEventListener('change', function(e) {
    var preview = document.getElementById('preview');
    // preview.innerHTML = '';
    selectedFiles = [...e.target.files]; // ÌååÏùº Î™©Î°ù Í∞±Ïã†

    for (let i = 0; i < e.target.files.length; i++) {
      let file = e.target.files[i];
      let reader = new FileReader();
      reader.onload = function(e) {
        let div = document.createElement('div');
        div.classList.add('preview-item');
        div.setAttribute('data-index', i); // ÌååÏùº Ïù∏Îç±Ïä§ Ï†ÄÏû•
        div.innerHTML = `
          <div class="flex gap-3">
            <div class="relative">
              <img src="${e.target.result}" class="w-20 h-20 md:w-32 md:h-32 lg:w-40 lg:h-40 border border-gray-500 rounded duration-200 hover:scale-95 hover:rounded-none" />
              <button class="remove-btn rounded-[50%] absolute top-2 duration-200 w-8 h-8 flex justify-center place-items-center right-2 p-2 bg-[#1f1f1f] hover:bg-red-500">
                <span class="material-symbols-outlined">
                  close
                </span>
              </button>
            </div>
          </div>
        `;

        div.querySelector('.remove-btn').addEventListener('click', function() {
          let index = parseInt(div.getAttribute('data-index')); // Ï†ÄÏû•Îêú Ïù∏Îç±Ïä§ ÏÇ¨Ïö©
          div.remove(); // ÎØ∏Î¶¨Î≥¥Í∏∞ Ï†úÍ±∞
          selectedFiles.splice(index, 1); // selectedFiles Î∞∞Ïó¥ÏóêÏÑú Ï†úÍ±∞
          updateFileIndexes(); // Ïù∏Îç±Ïä§ ÏóÖÎç∞Ïù¥Ìä∏
          
          // Ï≤®Î∂ÄÌååÏùº ÎØ∏Î¶¨Î≥¥Í∏∞ divÏùò Í∞ÄÏãúÏÑ± ÏÑ§Ï†ï
          updateFilePreviewVisibility();
        });

        preview.appendChild(div);
      };
      reader.readAsDataURL(file);
    }
    // Ï≤®Î∂ÄÌååÏùº ÎØ∏Î¶¨Î≥¥Í∏∞ divÏùò Í∞ÄÏãúÏÑ± ÏÑ§Ï†ï
    updateFilePreviewVisibility();
  });

  // ÌååÏùº ÎØ∏Î¶¨Î≥¥Í∏∞ div Í∞ÄÏãúÏÑ± ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
  function updateFilePreviewVisibility() {
    if (existingFiles.length + selectedFiles.length > 0) {
      $("#file_preview").show(); // ÌååÏùºÏù¥ ÏûàÏúºÎ©¥ Î≥¥Ïó¨Ï§å
    } else {
      $("#file_preview").hide(); // ÌååÏùºÏù¥ ÏóÜÏúºÎ©¥ Ïà®ÍπÄ
    }
  }

});

</script>